@page "/销售/报价/列表"

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center mb-3">
    <h3>销售报价</h3>
    <div>
        <button class="btn btn-primary" @onclick="@(e=>NavigationManager.NavigateTo($"/销售/报价/新增"))"><i class="oi oi-pencil"></i> 新增</button>
    </div>
</div>
<div class="row">
    <div class="col-12">
        <KTable TItem="dto销售报价" DataSource="list_Main" IsResponsive="true" IsBordered=" true" IsHovarable="true" IsTextNoWrap="true"
                CheckBoxHeader="true" IsSingleSelect="true" IsClickToSelect="true" @ref="table_Main" OnRowClicked="@(OnRowClicked)">
            <KTableConditionContainer TItem="dto销售报价">
                <KTableHiddenCondition TItem="dto销售报价" Predicate="m=>m.Model.IsSysColumn"></KTableHiddenCondition>
                <KTableHiddenCondition TItem="dto销售报价" Predicate="m=>m.Model.IsHiddenIndex"></KTableHiddenCondition>
                <KTableFormatCondition TItem="dto销售报价" Predicate="m=>m.Model.IsDatetime" ValueType="KTableValueType.DateTime" ValueFormat="yyyy-MM-dd"></KTableFormatCondition>
                <KTableFormatCondition TItem="dto销售报价" Predicate="m=>m.Model.IsDecimal" ValueType="KTableValueType.Decimal" ValueFormat="0.00"></KTableFormatCondition>
            </KTableConditionContainer>
            <KTableUserColumns TItem="dto销售报价">
                <KTableUserColumn TItem="dto销售报价" Width="1">
                    <a href="javascript:;" @onclick="@(e=>NavigationManager.NavigateTo($"/销售/报价/查看/{context.RecordId}"))" class="mr-1">查看</a>
                    <a href="javascript:;" @onclick="@(e=>NavigationManager.NavigateTo($"/销售/报价/修改/{context.RecordId}"))" class="mr-1">修改</a>
                    <a href="javascript:;" @onclick="@(e=>NavigationManager.NavigateTo($"/销售/报价/删除/{context.RecordId}"))">删除</a>
                </KTableUserColumn>
            </KTableUserColumns>
        </KTable>
    </div>
</div>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center mb-3 mt-3">
    <h4>明细</h4>
</div>

<div class="row">
    <div class="col-12">
        <KTable TItem="dto销售报价D" IsResponsive="true" IsBordered=" true" IsTextNoWrap="true" @ref="table_Details">
            <KTableConditionContainer TItem="dto销售报价D">
                <KTableHiddenCondition TItem="dto销售报价D" Predicate="m=>m.Model.IsSysColumn"></KTableHiddenCondition>
                <KTableHiddenCondition TItem="dto销售报价D" Predicate="m=>m.Model.IsHiddenIndex"></KTableHiddenCondition>
                <KTableFormatCondition TItem="dto销售报价D" Predicate="m=>m.Model.IsDatetime" ValueType="KTableValueType.DateTime" ValueFormat="yyyy-MM-dd"></KTableFormatCondition>
                <KTableFormatCondition TItem="dto销售报价D" Predicate="m=>m.Model.IsDecimal" ValueType="KTableValueType.Decimal" ValueFormat="0.00"></KTableFormatCondition>
            </KTableConditionContainer>
        </KTable>
    </div>
</div>

@code {
    protected List<dto销售报价> list_Main { get; set; }
    protected List<dto销售报价D> list_Details { get; set; }

    protected KTable<dto销售报价> table_Main { get; set; }
    protected KTable<dto销售报价D> table_Details { get; set; }

    protected void OnRowClicked(KTableEvent<dto销售报价> e)
    {
        System.Diagnostics.Debug.WriteLine(Newtonsoft.Json.JsonConvert.SerializeObject(e.Row, Newtonsoft.Json.Formatting.Indented));
        var datasource = mapper.ProjectTo<dto销售报价D>(pinhuaContext.tb_报价表D.AsNoTracking().Where(m => m.RecordId == e.Row.RecordId)).ToList();
        System.Diagnostics.Debug.WriteLine(Newtonsoft.Json.JsonConvert.SerializeObject(datasource, Newtonsoft.Json.Formatting.Indented));
        table_Details.SetDataSource(datasource);
    }

    protected override void OnInitialized()
    {
        list_Main = mapper.ProjectTo<dto销售报价>(pinhuaContext.tb_报价表).ToList();
        list_Details = mapper.ProjectTo<dto销售报价D>(pinhuaContext.tb_报价表D).ToList();
    }
}